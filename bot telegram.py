import logging
import io
import asyncio
from rembg import remove
from PIL import Image
from telegram import Update
from telegram.ext import Application, MessageHandler, filters, CommandHandler, CallbackContext

# Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªÙˆÙƒÙ†
TOKEN = '*************** api'  # ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¶Ø¹ Ø§Ù„ØªÙˆÙƒÙ† Ø§Ù„ØµØ­ÙŠØ­

# Ø¥Ø¹Ø¯Ø§Ø¯ Ù†Ø¸Ø§Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
logging.basicConfig(
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s",
    level=logging.DEBUG,  # Ø¬Ø¹Ù„ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ DEBUG Ù„Ø±Ø¤ÙŠØ© ÙƒÙ„ Ø´ÙŠØ¡
)

# Ø¯Ø§Ù„Ø© Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ± ÙˆØ¥Ø²Ø§Ù„Ø© Ø§Ù„Ø®Ù„ÙÙŠØ©
async def remove_background(update: Update, context: CallbackContext):
    chat_id = update.message.chat_id
    logging.info(f"ğŸ“¸ ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… ØµÙˆØ±Ø© Ù…Ù† {chat_id}")

    if update.message.photo:
        photo_file = await update.message.photo[-1].get_file()
        photo_bytes = await photo_file.download_as_bytearray()

        logging.info("âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©ØŒ Ø¬Ø§Ø±ÙŠ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø®Ù„ÙÙŠØ©...")

        input_image = Image.open(io.BytesIO(photo_bytes))
        output_image = remove(input_image)

        bio = io.BytesIO()
        output_image.save(bio, format="PNG")
        bio.seek(0)

        await context.bot.send_photo(chat_id=chat_id, photo=bio)
        await update.message.reply_text("âœ… ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø®Ù„ÙÙŠØ©! Ø£Ø±Ø³Ù„ ØµÙˆØ±Ø© Ø£Ø®Ø±Ù‰ Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª.")
    else:
        await update.message.reply_text("âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ ØµÙˆØ±Ø©!")

# Ø¯Ø§Ù„Ø© Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø¨ÙˆØª
async def start(update: Update, context: CallbackContext):
    logging.info(f"ğŸ¤– Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯: {update.message.chat_id}")
    await update.message.reply_text("ğŸ‘‹ Ù…Ø±Ø­Ø¨Ù‹Ø§! Ø£Ø±Ø³Ù„ Ù„ÙŠ ØµÙˆØ±Ø© ÙˆØ³Ø£Ø²ÙŠÙ„ Ø§Ù„Ø®Ù„ÙÙŠØ© Ù„Ùƒ.")

# Ø§Ù„ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª
def main():
    app = Application.builder().token(TOKEN).build()

    app.add_handler(CommandHandler("start", start))
    app.add_handler(MessageHandler(filters.PHOTO, remove_background))

    logging.info("ğŸ¤– Ø§Ù„Ø¨ÙˆØª Ù‚ÙŠØ¯ Ø§Ù„ØªØ´ØºÙŠÙ„...")
    app.run_polling()

if __name__ == '__main__':
    main()
